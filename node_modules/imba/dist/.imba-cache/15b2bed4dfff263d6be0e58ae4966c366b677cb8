{"js":{"code":"function defineName$__(cls,name){\n\tObject.defineProperty(cls,\"name\",{value:name,configurable:true});\n};;\nfunction inheritClass$__(cls){\n\tObject.getPrototypeOf(cls.prototype).constructor?.inherited?.(cls);\n};\nimport {accessor as imba_accessor} from 'imba';\nvar $1 = Symbol('a'), $2 = Symbol(), $3 = Symbol('b'), $4 = Symbol(), $5 = Symbol('c'), $6 = Symbol(), $7 = Symbol('pa'), $8 = Symbol(), $9 = Symbol('pb'), $10 = Symbol(), $11 = Symbol(), $13, $14, $15, $16, $17;\nconst $__init__$ = Symbol.for('#__init__'), $__patch__$ = Symbol.for('#__patch__'), $__initor__$ = Symbol.for('#__initor__'), $__inited__$ = Symbol.for('#__inited__'), $__hooks__$ = Symbol.for('#__hooks__');\n\n/*body*/\n// Expose intricate edgecases around saving and resolving\nimport setup from '../setup';\n\nexport class Item extends OPObject {\n\t[$__patch__$]($$ = {},fields = true){\n\t\tvar $12;\n\t\tsuper[$__patch__$] && super[$__patch__$]($$,fields);\n\t\tfields && ($12 = $$.a) !== undefined && this.ααa.$init($12,this,$1,'a',$$);\n\t\tfields && ($12 = $$.b) !== undefined && this.ααb.$init($12,this,$3,'b',$$);\n\t\tfields && ($12 = $$.c) !== undefined && this.ααc.$init($12,this,$5,'c',$$);\n\t\tfields && ($12 = $$.pa) !== undefined && this.ααpa.$init($12,this,$7,'pa',$$);\n\t\tfields && ($12 = $$.pb) !== undefined && this.ααpb.$init($12,this,$9,'pb',$$);\n\t\t\n\t}\n\tconstructor(){\n\t\tsuper(...arguments);\n\t\tsuper[$__init__$] || this[$__init__$]();this[$__initor__$]===$11 && (this[$__hooks__$]&&this[$__hooks__$].inited(this),this[$__inited__$] && this[$__inited__$]());\n\t}\n\t[$__init__$]($$ = null,deep = true,fields = true){\n\t\tdeep && super[$__init__$] && super[$__init__$](...arguments);\n\t\tfields && this.ααa.$init($$ ? $$.a : undefined,this,$1,'a',$$);\n\t\tfields && this.ααb.$init($$ ? $$.b : undefined,this,$3,'b',$$);\n\t\tfields && this.ααc.$init($$ ? $$.c : undefined,this,$5,'c',$$);\n\t\tfields && this.ααpa.$init($$ ? $$.pa : undefined,this,$7,'pa',$$);\n\t\tfields && this.ααpb.$init($$ ? $$.pb : undefined,this,$9,'pb',$$);\n\t\t\n\t}\n\tset a(val){ this.ααa.$set(val,this,$1,'a') }\n\tget a(){ return this.ααa.$get(this,$1,'a') }\n\tget ααa(){ return this[$2] || imba_accessor(($13 = this.αnumber(),$13),this,$1,'a',$2,Item.prototype) }\n\tset b(val){ this.ααb.$set(val,this,$3,'b') }\n\tget b(){ return this.ααb.$get(this,$3,'b') }\n\tget ααb(){ return this[$4] || imba_accessor(($14 = this.αnumber(),$14),this,$3,'b',$4,Item.prototype) }\n\tset c(val){ this.ααc.$set(val,this,$5,'c') }\n\tget c(){ return this.ααc.$get(this,$5,'c') }\n\tget ααc(){ return this[$6] || imba_accessor(($15 = this.αnumber(),$15),this,$5,'c',$6,Item.prototype) }\n\tset pa(val){ this.ααpa.$set(val,this,$7,'pa') }\n\tget pa(){ return this.ααpa.$get(this,$7,'pa') }\n\tget ααpa(){ return this[$8] || imba_accessor(($16 = this.αnumber(),($16.pov instanceof Function) ? $16.pov() : ($16.pov = true),$16),this,$7,'pa',$8,Item.prototype) }\n\tset pb(val){ this.ααpb.$set(val,this,$9,'pb') }\n\tget pb(){ return this.ααpb.$get(this,$9,'pb') }\n\tget ααpb(){ return this[$10] || imba_accessor(($17 = this.αnumber(),($17.pov instanceof Function) ? $17.pov() : ($17.pov = true),$17),this,$9,'pb',$10,Item.prototype) }\n\tstatic {\n\t\tthis.prototype[$__initor__$] = $11;defineName$__(this,'Item');inheritClass$__(this);}\n};\n\nawait setup(__filename);\n\ntest(\"fast saving\",async function() {\n\t\n\tlet m = await Item.create({a: 1,b: 1});\n\tok(m.a,1);\n\tok(m.b,1);\n\t\n\t// change a and save\n\tm.a = 2;\n\tm.save();\n\tm.b = 2;\n\tawait m.save();\n\t\n\tok(m.a,2);\n\tok(m.b,2);\n\tok(m.$cloud.a,2);\n\treturn ok(m.$cloud.b,2);\n});\n\ntest(\"fast saving 2\",async function() {\n\t\n\tlet m = await Item.create({a: 1,b: 1});\n\tok(m.a,1);\n\tok(m.b,1);\n\t\n\t// change a and save\n\tm.a = 2;\n\tm.save();\n\tm.b = 2;\n\tawait m.save();\n\t\n\tok(m.a,2);\n\tok(m.b,2);\n\tok(m.$cloud.a,2);\n\treturn ok(m.$cloud.b,2);\n});\n\ntest.node(\"partial saving\",async function() {\n\t\n\tlet m = await Item.create({a: 1,b: 1});\n\tm.a = m.b = 2;\n\tawait m.save({only: 'a'});\n\tok(m.$cloud.a,2);\n\treturn ok(m.$cloud.b,1);\n});\n\ntest.node(\"partial saving 2\",async function() {\n\t\n\tlet m = await Item.create({a: 1,b: 1});\n\tm.a = m.b = 2;\n\tawait m.save({only: 'a'});\n\tm.a = 3;\n\tawait m.save({only: 'b'});\n\tok(m.$cloud.a,2);\n\treturn ok(m.$cloud.b,2);\n});\n\ntest.node(\"partial saving 3\",async function() {\n\t\n\tlet m = await Item.create({a: 1,b: 1});\n\tm.a = m.b = 2;\n\tm.save({only: 'a'});\n\tm.save({only: 'b'});\n\tok(m.$cloud.a,1);\n\tok(m.$cloud.b,1);\n\tawait m;\n\tok(m.$cloud.a,2);\n\treturn ok(m.$cloud.b,2);\n});\n\ntest.node(\"partial saving 4\",async function() {\n\t\n\tlet m = await Item.create({a: 1,b: 1});\n\tm.a = 2;\n\t// saving only something that hasnt changed\n\tawait m.save({only: 'b'});\n\tok(m.$cloud.a,1);\n\treturn ok(m.unsavedΦ);\n});\n\ntest.node(\"update\",async function() {\n\t\n\tlet m = await Item.create({a: 1,b: 1,c: 1});\n\tm.a = 2;\n\tawait m.update({b: 2,c: 2});\n\tok(m.$cloud.a,1);\n\tok(m.$cloud.b,2);\n\tok(m.$cloud.c,2);\n\tawait m.save();\n\treturn ok(m.$cloud.a,2);\n});\n\ndescribe(\"pov\",function() {\n\t\n\t\n\treturn test.node(\"not when partial\",function({sindre: sindre}) { return sindre.run(async function() {\n\t\t\n\t\tlet m = await Item.create({a: 1,b: 1});\n\t\tok(!(m.pov.$saving));\n\t\tm.pa = 1;\n\t\tok(m.pov.$plain.pa,1);\n\t\tok(!(m.pov.$cloud?.pa));\n\t\tok(m.unsavedΦ);\n\t\tawait m.save();\n\t\t\n\t\tok(m.pov.$cloud.pa,1);\n\t\tm.b = 2;\n\t\tm.pa = 2;\n\t\t// saving only something that hasnt changed\n\t\tawait m.save({only: 'b'});\n\t\tok(m.pov.$cloud.pa,1);\n\t\tawait m.save();\n\t\treturn ok(m.pov.$cloud.pa,2);\n\t}); });\n});\n\ntest.todo(\"reset during save\");\n\n// scheduling multiple only saves will break down unless\n// we have\n","dependencies":[],"map":{"version":3,"file":"saving.test.js","sourceRoot":"","sources":["/Users/sindre/repos/scrimba/op/test/core/saving.test.imba"],"sourcesContent":["# Expose intricate edgecases around saving and resolving\nimport setup from '../setup'\n\nexport class Item < OPObject\n\ta @number\n\tb @number\n\tc @number\n\tpa @number.pov\n\tpb @number.pov\n\nawait setup(__filename)\n\ntest \"fast saving\" do\n\tlet m = await Item.create(a: 1, b: 1)\n\tok m.a,1\n\tok m.b,1\n\n\t# change a and save\n\tm.a = 2\n\tm.save!\n\tm.b = 2\n\tawait m.save!\n\n\tok m.a,2\n\tok m.b,2\n\tok m.$cloud.a,2\n\tok m.$cloud.b,2\n\ntest \"fast saving 2\" do\n\tlet m = await Item.create(a: 1, b: 1)\n\tok m.a,1\n\tok m.b,1\n\n\t# change a and save\n\tm.a = 2\n\tm.save!\n\tm.b = 2\n\tawait m.save!\n\n\tok m.a,2\n\tok m.b,2\n\tok m.$cloud.a,2\n\tok m.$cloud.b,2\n\ntest.node \"partial saving\" do\n\tlet m = await Item.create(a: 1, b: 1)\n\tm.a = m.b = 2\n\tawait m.save(only: 'a')\n\tok m.$cloud.a,2\n\tok m.$cloud.b,1\n\ntest.node \"partial saving 2\" do\n\tlet m = await Item.create(a: 1, b: 1)\n\tm.a = m.b = 2\n\tawait m.save(only: 'a')\n\tm.a = 3\n\tawait m.save(only: 'b')\n\tok m.$cloud.a,2\n\tok m.$cloud.b,2\n\ntest.node \"partial saving 3\" do\n\tlet m = await Item.create(a: 1, b: 1)\n\tm.a = m.b = 2\n\tm.save(only: 'a')\n\tm.save(only: 'b')\n\tok m.$cloud.a,1\n\tok m.$cloud.b,1\n\tawait m\n\tok m.$cloud.a,2\n\tok m.$cloud.b,2\n\ntest.node \"partial saving 4\" do\n\tlet m = await Item.create(a: 1, b: 1)\n\tm.a = 2\n\t# saving only something that hasnt changed\n\tawait m.save(only: 'b')\n\tok m.$cloud.a,1\n\tok m.unsaved?\n\ntest.node \"update\" do\n\tlet m = await Item.create(a: 1, b: 1, c: 1)\n\tm.a = 2\n\tawait m.update(b: 2, c: 2)\n\tok m.$cloud.a,1\n\tok m.$cloud.b,2\n\tok m.$cloud.c,2\n\tawait m.save!\n\tok m.$cloud.a,2\n\ndescribe \"pov\" do\n\n\ttest.node \"not when partial\" do({sindre}) sindre.run do\n\t\tlet m = await Item.create(a: 1, b: 1)\n\t\tok !m.pov.$saving\n\t\tm.pa = 1\n\t\tok m.pov.$plain.pa,1\n\t\tok !m.pov.$cloud..pa\n\t\tok m.unsaved?\n\t\tawait m.save!\n\n\t\tok m.pov.$cloud.pa,1\n\t\tm.b = 2\n\t\tm.pa = 2\n\t\t# saving only something that hasnt changed\n\t\tawait m.save(only: 'b')\n\t\tok m.pov.$cloud.pa,1\n\t\tawait m.save!\n\t\tok m.pov.$cloud.pa,2\n\ntest.todo \"reset during save\"\n\n# scheduling multiple only saves will break down unless\n# we have\n"],"names":[],"mappings":"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"}},"css":{"code":""},"warnings":[],"errors":[]}
{"js":{"code":"\n/*body*/\nimport setup from '../setup';\nimport data from './schema';\n\nawait setup(__filename,{data: data});\n\ndescribe(\"permissions\",function() {\n\t\n\t\n\ttest(\"can create in hub\",function({h01: h01,u02: u02}) { return u02.run(async function() {\n\t\t\n\t\tlet course = OP.Course.build({name: \"My course\",lns: [h01]});\n\t\tok(h01.rolesΞfor(u02) & OP.OWNER);\n\t\tok(await course.save());\n\t\treturn ok(course.creator,u02);\n\t\t// await expect(course.save!).re\n\t}); });\n\t\n\ttest(\"cannot create in hub\",function({h01: h01,u04: u04}) { return u04.run(async function() {\n\t\t\n\t\tlet course = OP.Course.build({name: \"My course\",lns: [h01]});\n\t\tok((h01.rolesΞfor(u04) & OP.OWNER)==0);\n\t\tok(course.rolesΞfor(u04) & OP.CREATOR);\n\t\tok(course.$parents.has(h01));\n\t\tok(!(course.writableΞfor(u04)));\n\t\t// Should not allow to save course since u04 is not owner\n\t\t// of hub, and hub.courses can only be written to by owners.\n\t\treturn await expect(course.save()).rejects.toThrowError();\n\t}); });\n\t\n\treturn test(\"can edit hub later\",async function({h01: h01,u02: u02,u04: u04,u05: u05}) {\n\t\t\n\t\tlet course;\n\t\tawait u02.run(async function() {\n\t\t\t\n\t\t\tcourse = OP.Course.build({name: \"My course\",lns: [h01],owners: [u04]});\n\t\t\tok(course.rolesΞfor(u02) & OP.CREATOR);\n\t\t\tok(course.rolesΞfor(u04) & OP.OWNER);\n\t\t\tok((course.rolesΞfor(u05) & OP.OWNER)==0);\n\t\t\treturn ok(await course.save());\n\t\t});\n\t\t\n\t\t// u05 should not be allowed to save\n\t\tawait u05.run(async function() {\n\t\t\t\n\t\t\t// Trying to update without access should fail\n\t\t\treturn await expect(course.update({name: \"Other course\"})).rejects.toThrowError(OPNotAllowed);\n\t\t});\n\t\t\n\t\tawait u04.run(async function() {\n\t\t\t\n\t\t\t// u04 is allowed to edit the name\n\t\t\tawait course.update({name: \"Other course\"});\n\t\t\treturn ok(course.$cloud.name,\"Other course\");\n\t\t});\n\t\t\n\t\treturn await u04.run(async function() {\n\t\t\t\n\t\t\t// But not allowed to change\n\t\t\t\n\t\t\tawait course.update({name: \"Other course\"});\n\t\t\treturn ok(course.$cloud.name,\"Other course\");\n\t\t});\n\t});\n});\n","dependencies":[],"map":{"version":3,"file":"basics.test.js","sourceRoot":"","sources":["/Users/sindre/repos/scrimba/op/test/courses/basics.test.imba"],"sourcesContent":["import setup from '../setup'\nimport data from './schema'\n\nawait setup(__filename, data: data)\n\ndescribe \"permissions\" do\n\n\ttest \"can create in hub\" do({h01,u02}) u02.run do\n\t\tlet course = OP.Course.build(name: \"My course\", lns: [h01])\n\t\tok h01.roles-for(u02) & OP.OWNER\n\t\tok await course.save!\n\t\tok course.creator,u02\n\t\t# await expect(course.save!).re\n\n\ttest \"cannot create in hub\" do({h01,u04}) u04.run do\n\t\tlet course = OP.Course.build(name: \"My course\", lns: [h01])\n\t\tok h01.roles-for(u04) !& OP.OWNER\n\t\tok course.roles-for(u04) & OP.CREATOR\n\t\tok course.$parents.has(h01)\n\t\tok !course.writable-for(u04)\n\t\t# Should not allow to save course since u04 is not owner\n\t\t# of hub, and hub.courses can only be written to by owners.\n\t\tawait expect(course.save!).rejects.toThrowError!\n\n\ttest \"can edit hub later\" do({h01,u02,u04,u05})\n\t\tlet course\n\t\tawait u02.run do\n\t\t\tcourse = OP.Course.build(name: \"My course\", lns: [h01], owners: [u04])\n\t\t\tok course.roles-for(u02) & OP.CREATOR\n\t\t\tok course.roles-for(u04) & OP.OWNER\n\t\t\tok course.roles-for(u05) !& OP.OWNER\n\t\t\tok await course.save!\n\n\t\t# u05 should not be allowed to save\n\t\tawait u05.run do\n\t\t\t# Trying to update without access should fail\n\t\t\tawait expect(course.update(name: \"Other course\")).rejects.toThrowError(OPNotAllowed)\n\n\t\tawait u04.run do\n\t\t\t# u04 is allowed to edit the name\n\t\t\tawait course.update(name: \"Other course\")\n\t\t\tok course.$cloud.name,\"Other course\"\n\n\t\tawait u04.run do\n\t\t\t# But not allowed to change\n\n\t\t\tawait course.update(name: \"Other course\")\n\t\t\tok course.$cloud.name,\"Other course\"\n"],"names":[],"mappings":"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"}},"css":{"code":""},"warnings":[],"errors":[]}
{"js":{"code":"function defineName$__(cls,name){\n\tObject.defineProperty(cls,\"name\",{value:name,configurable:true});\n};\nconst $__initor__$ = Symbol.for('#__initor__'), $__inited__$ = Symbol.for('#__inited__'), $__hooks__$ = Symbol.for('#__hooks__');\n\n/*body*/\nimport {commit} from './scheduler';\n\nconst fn = function() { return true; };\n\nclass Storage {\n\t\n\tconstructor(store,ns = ''){\n\t\t\n\t\tthis.store = store || {};\n\t\tthis.cache = {raw: {},rich: {}};\n\t\tthis.ns = ns;\n\t\tthis.local = store == globalThis.sessionStorage;\n\t\tthis.children = new Map;\n\t}\n\t\n\tserialize(val,key){\n\t\t\n\t\treturn JSON.stringify(val);\n\t}\n\t\n\tdeserialize(val,key){\n\t\t\n\t\treturn JSON.parse(val);\n\t}\n\t\n\tgetItem(name){\n\t\t\n\t\tlet key = String(this.ns) + ':' + name;\n\t\t\n\t\tif (this.store instanceof Storage) {\n\t\t\t\n\t\t\treturn this.store.getItem(key);\n\t\t};\n\t\t\n\t\tif (this.local && this.cache.rich[key] != undefined) {\n\t\t\t\n\t\t\treturn this.cache.rich[key];\n\t\t};\n\t\t\n\t\tlet raw = this.store.getItem(key);\n\t\t// if we are\n\t\tif (raw != undefined) {\n\t\t\t\n\t\t\tif (this.cache.raw[key] == raw) {\n\t\t\t\t\n\t\t\t\treturn this.cache.rich[key];\n\t\t\t};\n\t\t\t\n\t\t\tthis.cache.raw[key] = raw;\n\t\t\treturn this.cache.rich[key] = this.deserialize(raw,key);\n\t\t};\n\t}\n\t\n\tsetItem(name,value){\n\t\tvar $1, $2;\n\t\t\n\t\tlet key = String(this.ns) + ':' + name;\n\t\t\n\t\tif (this.store instanceof Storage) {\n\t\t\t\n\t\t\treturn this.store.setItem(key,value);\n\t\t};\n\t\t\n\t\tlet cached = this.cache.rich[key];\n\t\tlet typ = typeof value;\n\t\t\n\t\tif (this.local) {\n\t\t\t\n\t\t\tthis.cache.rich[key] = value;\n\t\t};\n\t\t\n\t\tif (cached !== value || typ == 'object') {\n\t\t\t\n\t\t\tlet prev = this.store.getItem(key);\n\t\t\t\n\t\t\tif (value == undefined) {\n\t\t\t\t\n\t\t\t\tthis.store.removeItem(key);\n\t\t\t\t((($1 = this.cache.rich[key]),delete this.cache.rich[key], $1));\n\t\t\t\t((($2 = this.cache.raw[key]),delete this.cache.raw[key], $2));\n\t\t\t\treturn commit();\n\t\t\t} else {\n\t\t\t\t\n\t\t\t\tlet raw = this.serialize(value,key);\n\t\t\t\tthis.cache.rich[key] = value;\n\t\t\t\tthis.cache.raw[key] = raw;\n\t\t\t\t\n\t\t\t\tif (prev != raw) {\n\t\t\t\t\t\n\t\t\t\t\tthis.store.setItem(key,raw);\n\t\t\t\t\treturn commit();\n\t\t\t\t};\n\t\t\t};\n\t\t};\n\t}\n\t\n\tget(target,key,receiver){\n\t\t\n\t\treturn this.getItem(key);\n\t}\n\t\n\tset(target,key,value,receiver){\n\t\t\n\t\tthis.setItem(key,value);\n\t\treturn true;\n\t}\n\t\n\tapply(target,that,[name]){\n\t\t\n\t\tlet item = this.children.get(name);\n\t\titem || this.children.set(name,item = new Proxy(fn,new Storage(this,name)));\n\t\treturn item;\n\t}\n\t\n\tdeleteProperty(target,name){\n\t\tvar $3;\n\t\t\n\t\tlet key = this.ns + name;\n\t\t((($3 = this.cache[key]),delete this.cache[key], $3));\n\t\treturn this.store.removeItem(key);\n\t}\n\tstatic {\n\t\tdefineName$__(this,'Storage');}\n};\n\nexport const locals = new Proxy(fn,new Storage(globalThis.localStorage));\n\nexport const session = new Proxy(fn,new Storage(globalThis.sessionStorage));\n","dependencies":[],"map":{"version":3,"file":"storage.js","sourceRoot":"","sources":["/Users/sindre/repos/imba/packages/imba/src/imba/storage.imba"],"sourcesContent":["import {commit} from './scheduler'\n\nconst fn = do yes\n\nclass Storage\n\tdef constructor store, ns = ''\n\t\tself.store = store or {}\n\t\tself.cache = {raw:{},rich:{}}\n\t\tself.ns = ns\n\t\tself.local = store == global.sessionStorage\n\t\tself.children = new Map\n\n\tdef serialize val, key\n\t\tJSON.stringify(val)\n\n\tdef deserialize val, key\n\t\tJSON.parse(val)\n\n\tdef getItem name\n\t\tlet key = String(ns) + ':' + name\n\n\t\tif store isa Storage\n\t\t\treturn store.getItem(key)\n\n\t\tif local and cache.rich[key] != undefined\n\t\t\treturn cache.rich[key]\n\n\t\tlet raw = store.getItem(key)\n\t\t# if we are\n\t\tif raw != undefined\n\t\t\tif cache.raw[key] == raw\n\t\t\t\treturn cache.rich[key]\n\n\t\t\tcache.raw[key] = raw\n\t\t\treturn cache.rich[key] = deserialize(raw,key)\n\n\tdef setItem name, value\n\t\tlet key = String(ns) + ':' + name\n\n\t\tif store isa Storage\n\t\t\treturn store.setItem(key,value)\n\n\t\tlet cached = cache.rich[key]\n\t\tlet typ = typeof value\n\n\t\tif local\n\t\t\tcache.rich[key] = value\n\n\t\tif cached !== value or typ == 'object'\n\t\t\tlet prev = store.getItem(key)\n\n\t\t\tif value == undefined\n\t\t\t\tstore.removeItem(key)\n\t\t\t\tdelete cache.rich[key]\n\t\t\t\tdelete cache.raw[key]\n\t\t\t\tcommit!\n\t\t\telse\n\t\t\t\tlet raw = serialize(value,key)\n\t\t\t\tcache.rich[key] = value\n\t\t\t\tcache.raw[key] = raw\n\n\t\t\t\tif prev != raw\n\t\t\t\t\tstore.setItem(key,raw)\n\t\t\t\t\tcommit!\n\n\tdef get target,key,receiver\n\t\tgetItem(key)\n\n\tdef set target,key,value,receiver\n\t\tsetItem(key,value)\n\t\treturn yes\n\n\tdef apply target, that, [name]\n\t\tlet item = children.get(name)\n\t\titem || children.set(name,item = new Proxy(fn,new Storage(self,name)))\n\t\treturn item\n\n\tdef deleteProperty target, name\n\t\tlet key = ns + name\n\t\tdelete cache[key]\n\t\treturn store.removeItem(key)\n\nexport const locals = new Proxy(fn,new Storage(global.localStorage))\n\nexport const session = new Proxy(fn,new Storage(global.sessionStorage))"],"names":[],"mappings":"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"}},"css":{"code":""},"warnings":[],"errors":[]}
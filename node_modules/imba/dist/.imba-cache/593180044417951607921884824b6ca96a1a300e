{"js":{"code":"\n/*body*/\n\nexport function αlazy(target,key,desc){\n\t\n\tif (desc.get) {\n\t\t\n\t\tlet get = desc.get;\n\t\tdesc.get = function() {\n\t\t\t\n\t\t\tlet val = get.call(this);\n\t\t\tObject.defineProperty(this,key,{enumerable: false,value: val});\n\t\t\treturn val;\n\t\t};\n\t};\n\treturn desc;\n};\n\nexport function αbound(target,key,desc){\n\tvar $1, $2;\n\t\n\tif (desc.value instanceof Function) {\n\t\t\n\t\tlet fn = desc.value;\n\t\tdesc.get = function() {\n\t\t\t\n\t\t\tif (this == target) {\n\t\t\t\t\n\t\t\t\treturn fn;\n\t\t\t};\n\t\t\tlet val = fn.bind(this);\n\t\t\tObject.defineProperty(this,key,{enumerable: false,value: val});\n\t\t\treturn val;\n\t\t};\n\t\t((($1 = desc.value),delete desc.value, $1));\n\t\t((($2 = desc.writable),delete desc.writable, $2));\n\t};\n\treturn desc;\n};\n\nconst thenables = new WeakMap;\n\nexport function αthenable(target,key,desc){\n\t\n\t\n\tlet val = desc.value;\n\tlet sym = Symbol();\n\tlet thensym = Symbol();\n\t\n\tlet meta = thenables.get(target);\n\tmeta || thenables.set(target,meta = []);\n\t\n\tif (meta.length) {\n\t\t\n\t\tthrow new Error((`@thenable ` + (target.constructor?.name) + `.` + key + ` not allowed - @thenable ` + (meta[0][0]) + ` already defined`));\n\t};\n\t\n\tconst warn = function() {\n\t\t\n\t\treturn console.trace((`@thenable ` + (target.constructor?.name) + `.` + key + ` takes long - make sure method does not return self`));\n\t};\n\t\n\tmeta.push([key,sym]);\n\t\n\tif (val instanceof Function) {\n\t\t\n\t\tif (val.length > 0) {\n\t\t\t\n\t\t\tthrow new Error((`@thenable methods cannot be called with arguments (` + key + `)`));\n\t\t};\n\t\t\n\t\tObject.defineProperty(target,'then',{\n\t\t\tenumerable: false,\n\t\t\tvalue: function(ok,err) {\n\t\t\t\t\n\t\t\t\tlet that = this;\n\t\t\t\t\n\t\t\t\tlet promise = this[thensym] ||= new Promise(function(resolve,reject) {\n\t\t\t\t\t\n\t\t\t\t\t// TODO should only happen in debug\n\t\t\t\t\tlet timeout = setTimeout(warn,(5 * 1000));\n\t\t\t\t\t\n\t\t\t\t\tlet err = function(error) {\n\t\t\t\t\t\t\n\t\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\treturn that[key]().then(function() {\n\t\t\t\t\t\t\n\t\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t\t\tObject.defineProperty(that,'then',{value: null,writable: true,configurable: true});\n\t\t\t\t\t\treturn resolve(that);\n\t\t\t\t\t},err);\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\treturn promise.then(ok,err);\n\t\t\t}\n\t\t});\n\t\t\n\t\tdesc.value = function(value) {\n\t\t\t\n\t\t\treturn this[sym] ||= Promise.resolve(val.call(this));\n\t\t};\n\t\t\n\t\t// You can reset thenables explicitly by calling instance.myfunction.reset(instance)\n\t\tdesc.value.reset = function(target) {\n\t\t\tvar $3;\n\t\t\t\n\t\t\tif (target && target[sym]) {\n\t\t\t\t\n\t\t\t\ttarget[sym] = null;\n\t\t\t\ttarget[thensym] = null;\n\t\t\t\treturn ((($3 = target.then),delete target.then, $3));\n\t\t\t};\n\t\t};\n\t};\n\t\n\treturn desc;\n};\n","dependencies":[],"map":{"version":3,"file":"decorators.js","sourceRoot":"","sources":["/Users/sindre/repos/imba/packages/imba/src/imba/decorators.imba"],"sourcesContent":["\nexport def @lazy target, key, desc\n\tif desc.get\n\t\tlet get = desc.get\n\t\tdesc.get = do\n\t\t\tlet val = get.call(this)\n\t\t\tObject.defineProperty(this,key,{enumerable: no, value: val})\n\t\t\treturn val\n\treturn desc\n\nexport def @bound target, key, desc\n\tif desc.value isa Function\n\t\tlet fn = desc.value\n\t\tdesc.get = do\n\t\t\tif this == target\n\t\t\t\treturn fn\n\t\t\tlet val = fn.bind(this)\n\t\t\tObject.defineProperty(this,key,{enumerable: no, value: val})\n\t\t\treturn val\n\t\tdelete desc.value\n\t\tdelete desc.writable\n\treturn desc\n\nconst thenables = new WeakMap\n\nexport def @thenable target, key, desc\n\n\tlet val = desc.value\n\tlet sym = Symbol!\n\tlet thensym = Symbol!\n\n\tlet meta = thenables.get(target)\n\tmeta || thenables.set(target,meta = [])\n\n\tif meta.length\n\t\tthrow new Error(`@thenable {target.constructor..name}.{key} not allowed - @thenable {meta[0][0]} already defined`)\n\n\tconst warn = do\n\t\tconsole.trace `@thenable {target.constructor..name}.{key} takes long - make sure method does not return self`\n\n\tmeta.push([key,sym])\n\n\tif val isa Function\n\t\tif val.length > 0\n\t\t\tthrow new Error(`@thenable methods cannot be called with arguments ({key})`)\n\n\t\tObject.defineProperty(target,'then',{\n\t\t\tenumerable: no,\n\t\t\tvalue: do(ok,err)\n\t\t\t\tlet that = this\n\n\t\t\t\tlet promise = this[thensym] ||= new Promise do(resolve,reject)\n\t\t\t\t\t# TODO should only happen in debug\n\t\t\t\t\tlet timeout = setTimeout(warn,5s)\n\n\t\t\t\t\tlet err = do(error)\n\t\t\t\t\t\tclearTimeout(timeout)\n\t\t\t\t\t\treject(error)\n\n\t\t\t\t\tthat[key]().then(&,err) do\n\t\t\t\t\t\tclearTimeout(timeout)\n\t\t\t\t\t\tObject.defineProperty(that,'then',{value: null, writable: yes, configurable: yes})\n\t\t\t\t\t\tresolve(that)\n\n\t\t\t\tpromise.then(ok,err)\n\t\t})\n\n\t\tdesc.value = do(value)\n\t\t\tthis[sym] ||= Promise.resolve(val.call(this))\n\n\t\t# You can reset thenables explicitly by calling instance.myfunction.reset(instance)\n\t\tdesc.value.reset = do(target)\n\t\t\tif target and target[sym]\n\t\t\t\ttarget[sym] = null\n\t\t\t\ttarget[thensym] = null\n\t\t\t\tdelete target.then\n\n\treturn desc"],"names":[],"mappings":";;;AACA,MAAM,CAAC,QAAG,CAAC,KAAK,CAAC,MAAM,CAAE,GAAG,CAAE,IAAI,CAAA;;CACjC,EAAE,EAAC,IAAI,CAAC,GAAG,EAAA;;MACN,GAAG,GAAG,IAAI,CAAC,GAAG;EAClB,IAAI,CAAC,GAAG,GAAG,QAAE,GAAA;;OACR,GAAG,GAAG,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC;GACxB,MAAM,CAAC,cAAc,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,KAAE,CAAE,KAAK,EAAE,GAAG,CAAC,CAAC;GAC5D,MAAM,CAAC,GAAG;GAAA;EAAA;CACZ,MAAM,CAAC,IAAI;CAAA;;AAEZ,MAAM,CAAC,QAAG,CAAC,MAAM,CAAC,MAAM,CAAE,GAAG,CAAE,IAAI,CAAA;;;CAClC,EAAE,EAAC,IAAI,CAAC,KAAK,YAAK,QAAQ,EAAA;;MACrB,EAAE,GAAG,IAAI,CAAC,KAAK;EACnB,IAAI,CAAC,GAAG,GAAG,QAAE,GAAA;;GACZ,EAAE,EAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAA;;IAChB,MAAM,CAAC,EAAE;IAAA;OACN,GAAG,GAAG,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC;GACvB,MAAM,CAAC,cAAc,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,KAAE,CAAE,KAAK,EAAE,GAAG,CAAC,CAAC;GAC5D,MAAM,CAAC,GAAG;GAAA;EACX,QAAO,IAAI,CAAC,KAAK,SAAV,IAAI,CAAC,KAAK,MAAA;EACjB,QAAO,IAAI,CAAC,QAAQ,SAAb,IAAI,CAAC,QAAQ,MAAA;EAAA;CACrB,MAAM,CAAC,IAAI;CAAA;;MAEN,SAAS,GAAG,GAAG,CAAC,OAAO;;AAE7B,MAAM,CAAC,QAAG,CAAC,SAAS,CAAC,MAAM,CAAE,GAAG,CAAE,IAAI,CAAA;;;KAEjC,GAAG,GAAG,IAAI,CAAC,KAAK;KAChB,GAAG,GAAG,MAAM,EAAC;KACb,OAAO,GAAG,MAAM,EAAC;;KAEjB,IAAI,GAAG,SAAS,CAAC,GAAG,CAAC,MAAM,CAAC;CAChC,IAAI,CAAC,EAAE,CAAC,SAAS,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,GAAG,EAAE,CAAC;;CAEvC,EAAE,EAAC,IAAI,CAAC,MAAM,EAAA;;QACP,GAAG,CAAC,KAAK,CAAC,gBAAY,CAAA,MAAM,CAAC,WAAW,EAAE,IAAI,CAAA,SAAG,GAAG,iCAA2B,CAAA,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAC,sBAAkB,CAAC;EAAA;;OAE7G,IAAI,GAAG,QAAE,GAAA;;EACd,OAAA,OAAO,CAAC,KAAK,CAAC,gBAAY,CAAA,MAAM,CAAC,WAAW,EAAE,IAAI,CAAA,SAAG,GAAG,yDAAqD,CAAA;EAAA;;CAE9G,IAAI,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;;CAEpB,EAAE,EAAC,GAAG,YAAK,QAAQ,EAAA;;EAClB,EAAE,EAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,EAAA;;SACV,GAAG,CAAC,KAAK,CAAC,yDAAqD,GAAG,OAAG,CAAC;GAAA;;EAE7E,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC,MAAM,CAAC;GACnC,UAAU,EAAE,KAAE;GACd,KAAK,EAAE,QAAE,CAAC,EAAE,CAAC,GAAG,EAAC;;QACZ,IAAI,GAAG,IAAI;;QAEX,OAAO,GAAG,IAAI,CAAA,OAAQ,CAAC,KAAK,GAAG,CAAC,OAAO,CAAC,QAAE,CAAC,OAAO,CAAC,MAAM,EAAC;;;SAEzD,OAAO,GAAG,UAAU,CAAC,IAAI,CAAC,UAAE,CAAC;;SAE7B,GAAG,GAAG,QAAE,CAAC,KAAK,EAAC;;MAClB,YAAY,CAAC,OAAO,CAAC;MACrB,OAAA,MAAM,CAAC,KAAK,CAAC;MAAA;;KAEd,OAAA,IAAI,CAAA,GAAI,CAAC,EAAE,CAAC,IAAI,CAAQ,QAAE,GAAA;;MACzB,YAAY,CAAC,OAAO,CAAC;MACrB,MAAM,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,KAAK,EAAE,IAAI,CAAE,QAAQ,EAAE,IAAG,CAAE,YAAY,EAAE,IAAG,CAAC,CAAC;MAClF,OAAA,OAAO,CAAC,IAAI,CAAC;MAAA,CAHK,GAAG,CAAC;KAGT,CAX4B;;IAa3C,OAAA,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,GAAG,CAAC;IAAA;GACrB,CAAC;;EAEF,IAAI,CAAC,KAAK,GAAG,QAAE,CAAC,KAAK,EAAC;;UACrB,IAAI,CAAA,GAAI,CAAC,KAAK,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;GAAA;;;EAG9C,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,QAAE,CAAC,MAAM,EAAC;;;GAC5B,EAAE,EAAC,MAAM,CAAC,EAAG,CAAC,MAAM,CAAA,GAAI,CAAC,EAAA;;IACxB,MAAM,CAAA,GAAI,CAAC,GAAG,IAAI;IAClB,MAAM,CAAA,OAAQ,CAAC,GAAG,IAAI;IACtB,OAAA,QAAO,MAAM,CAAC,IAAI,SAAX,MAAM,CAAC,IAAI,MAAA;IAAA;GAAA;EAAA;;CAErB,MAAM,CAAC,IAAI;CAAA;AAAA;"}},"css":{"code":""},"warnings":[],"errors":[]}